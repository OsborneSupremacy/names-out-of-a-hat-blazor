
@inject NamesOutOfAHat2.Service.ValidationService ValidationService
@inject NamesOutOfAHat2.Service.EligibilityValidationService EligibilityValidationService
@inject NamesOutOfAHat2.Service.HatShakerService HatShakerService

@using NamesOutOfAHat2.Model.DomainModels
@using NamesOutOfAHat2.Model.ViewModels
@using NamesOutOfAHat2.Utility

@if(Visible)
{
    @foreach (var participant in Hat.Participants)
    {
        <ParticipantDisplay ParticipantViewModel="@participant" ParticpantEditedCallback="@ParticipantEditedCallback" ParticipantRemovedCallback="@ParticipantRemovedCallback" />
    }

    <ButtonArea>
        <PrimaryButton ClickedCallback="ShakeUpTheHat" Text="Shake Up The Hat" />
    </ButtonArea>
}

@code {

    [Parameter, EditorRequired]
    public bool Visible { get; set; }

    [Parameter, EditorRequired]
    public HatViewModel Hat { get; set; } = Hats.Empty;

    [Parameter, EditorRequired]
    public EventCallback SaveCallback { get; set; }

    [Parameter, EditorRequired]
    public EventCallback NextCallback { get; set; }

    [Parameter, EditorRequired]
    public EventCallback ShowErrorsCallback { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<ParticipantViewModel> ParticipantEditedCallback { get; set; }

    [Parameter, EditorRequired]
    public EventCallback<ParticipantViewModel> ParticipantRemovedCallback { get; set; }

    async Task ShakeUpTheHat()
    {
        await SaveCallback.InvokeAsync();

        var result = ValidationService.Validate(Hat);

        if (result.IsSuccess)
            result = EligibilityValidationService.Validate(Hat);

        if (!result.IsSuccess)
        {
            Hat = Hat with
            {
                Errors = result.GetErrors()
            };
            await ShowErrorsCallback.InvokeAsync();
            return;
        }

        var shakeResult = HatShakerService.ShakeMultiple(Hat, 100);

        Hat = Hat with
        {
            Errors = shakeResult.GetErrors()
        };

        if (!shakeResult.IsSuccess)
            await ShowErrorsCallback.InvokeAsync();
        else
            await NextCallback.InvokeAsync();
    }
}
